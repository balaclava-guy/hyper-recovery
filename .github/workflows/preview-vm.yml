name: Preview VM

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, or commit) to preview"
        required: false
        default: "main"
      preview_duration:
        description: "Seconds to keep the preview tunnel alive"
        required: false
        default: "600"
      debug:
        description: "Enable debug mode (verbose logs, usb-debug image)"
        required: false
        default: "true"
        type: boolean

jobs:
  preview-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Safety notice
        run: |
          echo "Preview exposes a temporary public URL via Cloudflare Tunnel." >&2
          echo "Do not use for sensitive data. URL is ephemeral and unauthenticated by default." >&2

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            substituters = https://cache.nixos.org https://cache.garnix.io
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=

      - name: Install QEMU + noVNC + cloudflared
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils ovmf novnc websockify curl lsof

          CLOUDFLARED_DEB="cloudflared-linux-amd64.deb"
          curl -fsSL -o "$CLOUDFLARED_DEB" https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i "$CLOUDFLARED_DEB" || sudo apt-get install -f -y
          cloudflared --version

      - name: Build ISO
        run: |
          set -euo pipefail
          if [ "${{ inputs.debug }}" == "true" ]; then
            PKG="usb-debug"
            echo "Building DEBUG image..."
          else
            PKG="usb"
            echo "Building STANDARD image..."
          fi
          nix build --accept-flake-config .#packages.x86_64-linux.$PKG --out-link result-iso --print-build-logs --refresh
          ISO_PATH=$(ls result-iso/iso/*.iso | head -1)
          echo "ISO_PATH=$ISO_PATH" >> $GITHUB_ENV

      - name: Start preview VM with VNC + noVNC + tunnel
        env:
          PREVIEW_DURATION: ${{ inputs.preview_duration }}
        run: |
          set -euo pipefail

          ISO_PATH="$ISO_PATH"

          # Locate firmware (match visual-smoke logic: prefer non-secureboot)
          OVMF_CODE=$(find /usr/share -name "OVMF_CODE*.fd" 2>/dev/null | grep -v snakeoil | grep -v ms | grep -v secboot | head -1)
          if [ -z "$OVMF_CODE" ]; then
            OVMF_CODE=$(find /usr/share -name "OVMF_CODE*.fd" 2>/dev/null | grep -v snakeoil | grep -v ms | head -1)
          fi
          OVMF_VARS_TEMPLATE=$(find /usr/share -name "OVMF_VARS*.fd" 2>/dev/null | grep -v snakeoil | grep -v ms | head -1)
          if [ -z "$OVMF_CODE" ] || [ -z "$OVMF_VARS_TEMPLATE" ]; then
            echo "OVMF firmware not found" >&2
            exit 1
          fi
          EFI_VARS="/tmp/OVMF_VARS_PREVIEW.fd"
          cp "$OVMF_VARS_TEMPLATE" "$EFI_VARS"

          # Start QEMU with virtio-gpu-pci (matching visual-smoke)
          qemu-system-x86_64 \
            -m 2048 -smp 2 \
            -device virtio-gpu-pci \
            -display none \
            -vnc :1 \
            -serial file:/tmp/qemu-serial.log \
            -drive file="$ISO_PATH",format=raw,if=none,id=drive-cd,readonly=on \
            -device ahci,id=ahci \
            -device ide-cd,drive=drive-cd,bus=ahci.0 \
            -boot order=d \
            -drive if=pflash,format=raw,readonly=on,file="$OVMF_CODE" \
            -drive if=pflash,format=raw,file="$EFI_VARS" \
            > /tmp/qemu-preview.log 2>&1 &
          QEMU_PID=$!

          # Wait for VNC port
          for i in {1..30}; do
            if (echo > /dev/tcp/127.0.0.1/5901) >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          # Launch websockify/noVNC serving on 6080
          NOVNC_DIR="/usr/share/novnc"
          websockify --web="$NOVNC_DIR" 6080 127.0.0.1:5901 > /tmp/websockify.log 2>&1 &
          WSOCK_PID=$!

          # Launch Cloudflare Tunnel (unauthenticated, ephemeral) with retries
          PREVIEW_URL=""
          for attempt in {1..5}; do
            : > /tmp/cloudflared.log
            cloudflared tunnel --url http://localhost:6080 --no-autoupdate > /tmp/cloudflared.log 2>&1 &
            CF_PID=$!

            for i in {1..30}; do
              if grep -Eo 'https://[0-9a-zA-Z.-]+\.trycloudflare\.com' /tmp/cloudflared.log | head -1 >/tmp/preview_url.txt; then
                PREVIEW_URL=$(cat /tmp/preview_url.txt)
                if [ -n "$PREVIEW_URL" ]; then break; fi
              fi
              sleep 1
            done

            if [ -n "$PREVIEW_URL" ]; then
              break
            fi

            echo "cloudflared attempt $attempt failed; retrying..." >&2
            kill $CF_PID || true
            sleep 2
          done

          if [ -z "$PREVIEW_URL" ]; then
            echo "Failed to obtain Cloudflare Tunnel URL after retries" >&2
            tail -n 50 /tmp/cloudflared.log || true
            exit 1
          fi

          echo "Preview URL: $PREVIEW_URL"
          echo "Open in browser: $PREVIEW_URL/vnc.html?autoconnect=true&resize=scale&path=websockify" | tee -a $GITHUB_STEP_SUMMARY
          echo "$PREVIEW_URL/vnc.html?autoconnect=true&resize=scale&path=websockify" > preview-url.txt

          echo "Preview will stay up for $PREVIEW_DURATION seconds or until the viewer disconnects (idle timeout)."

          IDLE_TIMEOUT=${IDLE_TIMEOUT:-300}
          deadline=$(( $(date +%s) + PREVIEW_DURATION ))
          no_client_since=$(date +%s)

          while true; do
            now=$(date +%s)
            if [ $now -ge $deadline ]; then
              echo "Reached preview deadline ($PREVIEW_DURATION s). Exiting."
              break
            fi

            # Detect active VNC client (websockify -> qemu VNC)
            if lsof -iTCP:5901 -sTCP:ESTABLISHED 2>/dev/null | tail -n +2 | grep -q .; then
              no_client_since=$now
            else
              idle_for=$(( now - no_client_since ))
              if [ $idle_for -ge $IDLE_TIMEOUT ]; then
                echo "No viewer for ${IDLE_TIMEOUT}s; exiting early."
                break
              fi
            fi

            # Exit early if QEMU died
            if ! kill -0 $QEMU_PID 2>/dev/null; then
              echo "QEMU exited; stopping preview."
              break
            fi

            sleep 3
          done

          kill $CF_PID $WSOCK_PID $QEMU_PID || true

      - name: Upload preview logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preview-vm-logs
          path: |
            /tmp/qemu-preview.log
            /tmp/qemu-serial.log
            /tmp/websockify.log
            /tmp/cloudflared.log
            preview-url.txt
          if-no-files-found: warn
