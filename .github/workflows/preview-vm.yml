name: Preview VM

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, or commit) to preview"
        required: false
        default: "main"
      preview_duration:
        description: "Seconds to keep the preview tunnel alive"
        required: false
        default: "900"

jobs:
  preview-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Safety notice
        run: |
          echo "Preview exposes a temporary public URL via Cloudflare Tunnel." >&2
          echo "Do not use for sensitive data. URL is ephemeral and unauthenticated by default." >&2

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27

      - name: Install QEMU + noVNC + cloudflared
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils ovmf novnc websockify curl

          CLOUDFLARED_DEB="cloudflared-linux-amd64.deb"
          curl -fsSL -o "$CLOUDFLARED_DEB" https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i "$CLOUDFLARED_DEB" || sudo apt-get install -f -y
          cloudflared --version

      - name: Build ISO (main)
        run: |
          set -euo pipefail
          nix build .#packages.x86_64-linux.usb --out-link result-iso --print-build-logs --refresh
          ISO_PATH=$(ls result-iso/iso/*.iso | head -1)
          echo "ISO_PATH=$ISO_PATH" >> $GITHUB_ENV

      - name: Start preview VM with VNC + noVNC + tunnel
        env:
          PREVIEW_DURATION: ${{ inputs.preview_duration }}
        run: |
          set -euo pipefail

          ISO_PATH="$ISO_PATH"

          # Locate firmware
          OVMF_CODE=$(find /usr/share -name "OVMF_CODE*.fd" 2>/dev/null | grep -v snakeoil | grep -v ms | head -1)
          OVMF_VARS_TEMPLATE=$(find /usr/share -name "OVMF_VARS*.fd" 2>/dev/null | grep -v snakeoil | grep -v ms | head -1)
          if [ -z "$OVMF_CODE" ] || [ -z "$OVMF_VARS_TEMPLATE" ]; then
            echo "OVMF firmware not found" >&2
            exit 1
          fi
          EFI_VARS="/tmp/OVMF_VARS_PREVIEW.fd"
          cp "$OVMF_VARS_TEMPLATE" "$EFI_VARS"

          # Start QEMU with QXL VGA (VNC-friendly) on :1 (5901)
          qemu-system-x86_64 \
            -m 2048 -smp 2 \
            -device virtio-vga \
            -display vnc=:1 \
            -serial file:/tmp/qemu-serial.log \
            -drive file="$ISO_PATH",format=raw,if=none,id=drive-cd,readonly=on \
            -device ahci,id=ahci \
            -device ide-cd,drive=drive-cd,bus=ahci.0 \
            -boot order=d \
            -no-reboot \
            -drive if=pflash,format=raw,readonly=on,file="$OVMF_CODE" \
            -drive if=pflash,format=raw,file="$EFI_VARS" \
            > /tmp/qemu-preview.log 2>&1 &
          QEMU_PID=$!

          # Wait for VNC port
          for i in {1..30}; do
            if (echo > /dev/tcp/127.0.0.1/5901) >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          # Launch websockify/noVNC serving on 6080
          NOVNC_DIR="/usr/share/novnc"
          websockify --web="$NOVNC_DIR" 6080 127.0.0.1:5901 > /tmp/websockify.log 2>&1 &
          WSOCK_PID=$!

          # Launch Cloudflare Tunnel (unauthenticated, ephemeral) with retries
          PREVIEW_URL=""
          for attempt in {1..5}; do
            : > /tmp/cloudflared.log
            cloudflared tunnel --url http://localhost:6080 --no-autoupdate > /tmp/cloudflared.log 2>&1 &
            CF_PID=$!

            for i in {1..30}; do
              if grep -Eo 'https://[0-9a-zA-Z.-]+\.trycloudflare\.com' /tmp/cloudflared.log | head -1 >/tmp/preview_url.txt; then
                PREVIEW_URL=$(cat /tmp/preview_url.txt)
                if [ -n "$PREVIEW_URL" ]; then break; fi
              fi
              sleep 1
            done

            if [ -n "$PREVIEW_URL" ]; then
              break
            fi

            echo "cloudflared attempt $attempt failed; retrying..." >&2
            kill $CF_PID || true
            sleep 2
          done

          if [ -z "$PREVIEW_URL" ]; then
            echo "Failed to obtain Cloudflare Tunnel URL after retries" >&2
            tail -n 50 /tmp/cloudflared.log || true
            exit 1
          fi

          echo "Preview URL: $PREVIEW_URL"
          echo "Open in browser: $PREVIEW_URL/vnc.html?autoconnect=true&resize=scale&path=websockify" | tee -a $GITHUB_STEP_SUMMARY
          echo "$PREVIEW_URL/vnc.html?autoconnect=true&resize=scale&path=websockify" > preview-url.txt

          echo "Preview will stay up for $PREVIEW_DURATION seconds. Press Ctrl+C to end early."
          sleep "$PREVIEW_DURATION"

          kill $CF_PID $WSOCK_PID $QEMU_PID || true

      - name: Upload preview logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preview-vm-logs
          path: |
            /tmp/qemu-preview.log
            /tmp/websockify.log
            /tmp/cloudflared.log
            preview-url.txt
          if-no-files-found: warn
