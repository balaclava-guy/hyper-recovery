name: Fetch & Store Artifacts

on:
  check_suite:
    types: [completed]
  workflow_dispatch:

jobs:
  fetch-artifacts:
    name: Fetch Artifacts from Garnix
    # Only run if:
    # 1. It's a check_suite event from 'garnix-ci' and it succeeded
    # 2. OR it's a manual dispatch
    if: |
      (github.event_name == 'check_suite' && 
       github.event.check_suite.app.slug == 'garnix-ci' && 
       github.event.check_suite.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Important: For check_suite, we must checkout the commit that was checked!
          # Otherwise default checkout might be different if pushes happened.
          ref: ${{ github.event.check_suite.head_sha || github.sha }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            substituters = https://cache.nixos.org https://cache.garnix.io
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=

      - name: Fetch from Cache
        run: |
          echo "::group::Fetching Artifacts"
          echo "Fetching artifacts from Garnix cache for commit $(git rev-parse --short HEAD)..."
          
          # Build the images-7z package. 
          # Since Garnix already built this successfully (check_suite=success),
          # this should just download the closure from cache.garnix.io.
          # We add --refresh to ensure we check the remote cache.
          nix build .#images-7z --out-link result-artifacts --print-build-logs --refresh
          
          echo "::endgroup::"

      - name: Stage Artifacts
        run: |
          mkdir -p dist
          # Find .7z files AND .iso files (we stopped compressing ISOs)
          # Use -L to follow symlinks because result-artifacts is a symlink
          find -L result-artifacts \( -name "*.7z" -o -name "*.iso" \) -exec cp {} dist/ \;
          
          count=$(ls dist/* 2>/dev/null | wc -l)
          if [ "$count" -eq 0 ]; then
            echo "::error::No artifacts found in build result!"
            exit 1
          fi
          echo "Found $count artifact(s)."

      - name: Upload to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: hyper-recovery-builds
          path: |
            dist/*.7z
            dist/*.iso
          if-no-files-found: error
          retention-days: 90
