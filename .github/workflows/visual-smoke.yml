name: Visual Smoke Test

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  visual-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            substituters = https://cache.nixos.org https://cache.garnix.io
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=

      - name: Install QEMU + Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils socat imagemagick ffmpeg ovmf

      - name: Build ISO
        run: |
          nix build .#packages.x86_64-linux.usb --out-link result-iso --print-build-logs --refresh
          ISO_PATH=$(ls result-iso/iso/*.iso | head -1)
          echo "ISO_PATH=$ISO_PATH" >> $GITHUB_ENV

      - name: Boot ISO and capture visuals
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p artifacts

          VIDEO_SECONDS=60

          run_boot() {
            local mode=$1
            local vnc_port=$2
            local monitor_socket=$3
            local serial_log=$4
            local prefix=$5
            shift 5
            local firmware_args=("$@")

            qemu-system-x86_64 \
              -m 2048 -smp 2 \
              -device virtio-gpu-pci \
              -display none \
              -vnc :"$vnc_port" \
              -serial file:"$serial_log" \
              -monitor unix:"$monitor_socket",server,nowait \
              -cdrom "$ISO_PATH" \
              -boot d \
              -no-reboot \
              "${firmware_args[@]}" &

            QEMU_PID=$!

            # Wait for monitor socket
            for i in {1..30}; do
              if [ -S "$monitor_socket" ]; then
                break
              fi
              sleep 1
            done

            # Wait for VNC port
            for i in {1..30}; do
              if (echo > /dev/tcp/127.0.0.1/$((5900 + vnc_port))) >/dev/null 2>&1; then
                break
              fi
              sleep 1
            done

            # Start low-FPS recording (entire boot window)
            ffmpeg -y -f vnc -i 127.0.0.1:"$vnc_port" -r 5 -t "$VIDEO_SECONDS" "artifacts/${prefix}-boot.mp4" -loglevel error &
            FFMPEG_PID=$!

            capture_shot() {
              local name=$1
              printf "screendump artifacts/%s.ppm\n" "$name" | socat - UNIX-CONNECT:"$monitor_socket"
              convert "artifacts/$name.ppm" "artifacts/$name.png"
            }

            sleep 6
            capture_shot "${prefix}-shot1"
            sleep 6
            capture_shot "${prefix}-shot2"
            sleep 8
            capture_shot "${prefix}-shot3"

            # Let the recording finish the full duration
            remaining=$((VIDEO_SECONDS - 20))
            if [ "$remaining" -gt 0 ]; then
              sleep "$remaining"
            fi

            # Brightness check (fail if all shots are nearly black)
            mean1=$(convert "artifacts/${prefix}-shot1.png" -colorspace gray -format "%[mean]" info:)
            mean2=$(convert "artifacts/${prefix}-shot2.png" -colorspace gray -format "%[mean]" info:)
            mean3=$(convert "artifacts/${prefix}-shot3.png" -colorspace gray -format "%[mean]" info:)

            echo "$mode shot means: $mean1 $mean2 $mean3"

            is_bright=$(awk -v m1="$mean1" -v m2="$mean2" -v m3="$mean3" 'BEGIN {print ((m1>0.02)||(m2>0.02)||(m3>0.02)) ? 1 : 0}')
            if [ "$is_bright" -ne 1 ]; then
              echo "$mode screenshots are too dark. Plymouth may be missing."
              exit 1
            fi

            # Wait for recording to complete
            wait "$FFMPEG_PID" || true

            # Shutdown QEMU
            printf "system_powerdown\n" | socat - UNIX-CONNECT:"$monitor_socket" || true
            sleep 3
            kill "$QEMU_PID" || true
          }

          # BIOS boot test
          run_boot "bios" 1 /tmp/qemu-monitor-bios artifacts/serial-bios.log bios

          # EFI boot test
          EFI_CODE="/usr/share/OVMF/OVMF_CODE.fd"
          EFI_VARS="/tmp/OVMF_VARS.fd"
          cp /usr/share/OVMF/OVMF_VARS.fd "$EFI_VARS"
          run_boot "efi" 2 /tmp/qemu-monitor-efi artifacts/serial-efi.log efi \
            -drive if=pflash,format=raw,readonly=on,file="$EFI_CODE" \
            -drive if=pflash,format=raw,file="$EFI_VARS"

      - name: Upload visual artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-smoke
          path: |
            artifacts/bios-shot1.png
            artifacts/bios-shot2.png
            artifacts/bios-shot3.png
            artifacts/bios-boot.mp4
            artifacts/serial-bios.log
            artifacts/efi-shot1.png
            artifacts/efi-shot2.png
            artifacts/efi-shot3.png
            artifacts/efi-boot.mp4
            artifacts/serial-efi.log
          if-no-files-found: warn
